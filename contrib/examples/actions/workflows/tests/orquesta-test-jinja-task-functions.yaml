version: 1.0

description: A basic workflow testing task related functions.

vars:
  - loop: True

tasks:
  # Test basic task function.
  task1:
    action: core.echo message="foobar"
    next:
      - publish:
          - this_task_no_arg: '{{ task().task_id }}'
          - this_task_by_name: '{{ task("task1").task_id }}'

  # Test task function in a cycle.
  task2:
    action: core.noop
    next:
      - do: task3
  task3:
    action: core.local
    input:
      cmd: 'echo "{{ ctx("loop") }}"; sleep 1'
    next:
      - when: '{{ ctx("loop") == true }}'
        publish:
          - loop: False
        do: task3
      - when: '{{ ctx("loop") != true }}'
        do: task4
  task4:
    action: core.noop

  # Test task function in a reuse (split).
  task5:
    action: core.noop
    next:
      - do: task7
  task6:
    action: core.noop
    next:
      - do: task7
  task7:
    action: core.noop
    next:
      - publish:
          - task7_id: '{{ task("task7").task_id }}'
        do: task8
  task8:
    action: core.echo
    input:
      message: '{{ ctx("task7_id") }}'

output:
  - this_task_no_arg: '{{ ctx("this_task_no_arg") }}'
  - this_task_by_name: '{{ ctx("this_task_by_name") }}'
  - that_task_by_name: '{{ task("task1").task_id }}'
  - last_task3_result: '{{ not not task("task3").result.stdout }}'
  - task8__1__parent: '{{ task("task8__1").result.stdout }}'
  - task8__2__parent: '{{ task("task8__2").result.stdout }}'
